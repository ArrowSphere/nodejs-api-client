name: Security & Dependency Audit

on:
  pull_request:
    paths:
      - 'package.json'
      - 'yarn.lock'

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get base ref for PR or previous commit for push
        id: base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "BASE_REF=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
          else
            echo "BASE_REF=${{ github.event.before }}" >> $GITHUB_ENV
          fi

      - name: Check if dependencies or devDependencies changed
        id: deps_changed
        run: |
          git fetch origin $BASE_REF
          git show $BASE_REF:package.json > package.json.base || true
          jq '.dependencies, .devDependencies' package.json > deps.json
          jq '.dependencies, .devDependencies' package.json.base > deps.base.json
          if diff deps.json deps.base.json > /dev/null && [ ! -n "$(git diff --name-only $BASE_REF yarn.lock)" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.deps_changed.outputs.changed == 'true'
        run: yarn install --frozen-lockfile

      - name: Check registry provenance
        if: steps.deps_changed.outputs.changed == 'true'
        run: make check-registry

      - name: Run Snyk to check for vulnerabilities
        if: steps.deps_changed.outputs.changed == 'true'
        uses: snyk/actions/node@master
        env:
         SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
         command: test
